
# Shutter Rank - Спецификация функционала

Этот документ описывает ключевые реализованные функции и требования к приложению Shutter Rank для обеспечения консистентности при тестировании и дальнейшей разработке.

## 1. Основное приложение (Голосование)

### 1.1. Управление сессиями
- Приложение поддерживает несколько независимых сессий голосования.
- Доступ к конкретной сессии осуществляется через хэш в URL (например, `index.html#session-name`).
- При отсутствии хэша пользователю отображается страница выбора из всех доступных сессий.
- В случае ошибки загрузки или отсутствия сессии отображается соответствующее сообщение.
- **Навигация "Домой"**: В шапке сессии есть кнопка (иконка дома), позволяющая вернуться к списку всех сессий.

### 1.2. Пользовательский интерфейс (UI)
- **Вступительная статья**: При первом входе в сессию отображается модальное окно с форматированной статьей (Markdown).
- **Два режима отображения ленты**:
    1.  **Сетка (Grid)**: Фотографии отображаются с фиксированными пропорциями (настраивается в `Settings`).
    2.  **Оригинальные пропорции (Original/Masonry)**: Фотографии отображаются с сохранением исходных пропорций в несколько колонок.
- **Адаптивность**: Интерфейс адаптирован для десктопных и мобильных устройств.
- **Настройки вида**: Пользователь может изменять режим отображения и пропорции сетки через модальное окно настроек. Выбор сохраняется в `localStorage`.
- **Кастомные диалоги**: Все системные сообщения (`confirm`) заменены на кастомные неблокирующие модальные окна, которые не прерывают полноэкранный режим.
- **Кнопка "Поделиться"**: В заголовке сессии доступна кнопка для копирования прямой ссылки на текущую сессию в буфер обмена.
- **Стабильность лэйаута**: Используется `scrollbar-gutter: stable` для предотвращения смещения контента при появлении полосы прокрутки.

### 1.3. Процесс голосования
- **Система рейтинга**: 5-звёздочная система оценки.
- **Нормализованный подсчет (Weighted Score)**:
    - Для борьбы с дисперсией оценок используется параллельный подсчет нормированных баллов.
    - Формула: `Score = 1 + (Rating - 1) * 0.25`. (1 звезда = 1 балл, 5 звезд = 2 балла).
    - Это снижает вес "экстремальных" оценок (5 звезд) по сравнению с базовыми (1 звезда).
- **Лимиты голосования**:
    - Ограничение на количество оцененных фотографий (`ratedPhotoLimit`).
    - Ограничение на общую сумму потраченных звёзд (`totalStarsLimit`).
- **Индикаторы лимитов**: В основной и "липкой" шапке отображается статистика по использованным лимитам.
    - Визуально шкала заполняется суммой валидных и кредитных голосов (до лимита).
    - Текст красного цвета показывает только реальное превышение ("+N в кредите").
- **Сохранение прогресса**:
    - Валидные голоса: Сохраняются в Firebase Realtime Database в реальном времени.
    - Кредитные голоса: Сохраняются в `localStorage` и синхронизируются с Firebase при появлении места.
- **Защита от Race Condition**: Используется `useRef` (`userFirebaseRatingsRef`) для хранения мгновенного состояния голосов на клиенте.
- **Сброс голосов**: Пользователь может сбросить все свои оценки для текущей сессии через кастомный диалог подтверждения.
- **Фото "вне конкурса"**: У таких фото скрыт блок голосования (звезды), и они имеют пунктирную обводку.

### 1.4. Результаты голосования ("Показать общие")
- В этом режиме отображается расширенная статистика по каждому фото:
    1.  **Звезды**: Суммарное количество звезд (классический рейтинг).
    2.  **Баллы**: Сумма нормированных баллов.
    3.  **Голоса**: Количество людей, проголосовавших за фото.
- Доступна сортировка списка по любому из этих показателей, а также по ID.

### 1.5. Динамический рейтинг (разблокировка 4-й и 5-й звезды)
- По умолчанию для оценки доступны только 1-3 звезды.
- 4-я и 5-я звезды визуально отличаются (пониженная прозрачность).
- Разблокировка 4-й и 5-й звезды происходит автоматически, если суммарный рейтинг фотографии (от всех пользователей) превышает средний рейтинг по сессии на определённый процент.

### 1.6. Группы фотографий ("Спойлер" / Row Expander)
- **Визуализация**: Группа отображается как стопка карточек.
- **Парадигма Row Expander**: В режиме сетки (Grid) раскрытие группы раздвигает пространство между рядами, показывая содержимое группы ("Google Images" style).
- **Выбор и оценка**:
    - При установке оценки (звёзд) на любую фотографию в раскрытой группе, она **автоматически становится "выбранной"**.
    - Если пользователь снимает оценку, статус "выбранной" снимается.
    - Поддерживается перенос оценки между фото одной группы.
- **Навигация (Scoped Navigation)**:
    - Если открыть полноэкранный режим (Immersive) кликом по фото внутри **раскрытой** группы, навигация (Вперед/Назад) ограничивается только фотографиями этой группы.
    - Если открыть группу через "Лучшее из группы" (в свернутом состоянии), навигация идет по всей ленте.

### 1.7. Режимы просмотра (Modal / Immersive)
- **"Умные" рамки и виньетирование**:
    - Фото из группы, которое **выбрано**, имеет яркую рамку.
    - Остальные фото из той же группы имеют эффект **виньетирования** (затемнение по краям).
- **"Экспертный режим"**: В режиме просмотра доступна кнопка "Перейти в группу", открывающая модальное окно для детального сравнения всех фото группы.

### 1.8. Система видимости фотографий
- **Метафора "Глаза"**: Иконка глаза для управления видимостью.
- **Запрет на скрытие**: Оцененные фотографии скрыть нельзя.
- **Глобальный фильтр**: Переключатель "Показывать скрытые" временно возвращает скрытые фото в ленту.

### 1.9. Кредитное голосование (Credit Voting)
Пользователь может продолжать голосовать после исчерпания лимитов.

- **Модель "Айсберг" (Частичная валидность)**:
    - Одна фотография может быть частично валидной (хранится в Firebase) и частично кредитной (хранится в LocalStorage).
- **Очередь (FIFO)**:
    - Кредитные части голосов выстраиваются в очередь.
    - При освобождении ресурса система проверяет очередь и "повышает" старейший кредитный голос.
- **Визуальная кодировка ЗВЕЗД (Ресурс)**:
    - **Желтая**: Звезда укладывается в общий лимит.
    - **Голубая (Cyan)**: Звезда превышает общий лимит.
    - **Индиго**: Звезда укладывается в лимит звезд, но для фото **нет свободного слота**.
- **Визуальная кодировка РАМОК (Статус зачета)**:
    - **Желтая**: Фото в слоте, все звезды обеспечены. (ОК).
    - **Оранжевая**: Фото в слоте, но часть звезд кредитная.
    - **Индиго**: Фото НЕ в слоте (лимит фото исчерпан).
    - **Синяя/Голубая**: Фото в слоте, но ВСЕ звезды кредитные.

### 1.10. Архивный режим (Завершенное голосование)
Администратор может пометить сессию как завершенную (`isVotingClosed: true`).
- **Индикация**:
    - В списке сессий такие сессии отмечены иконкой "Глаз".
    - При входе показывается приветливое синее модальное окно "Голосование завершено, но!..".
    - В шапке рядом с названием сессии висит бейдж "Архив".
- **Ограничения**:
    - Блок выставления оценок (звезды) становится неактивным (disabled).
    - Кнопка "Сбросить оценки" скрыта.
- **Возможности**:
    - Пользователь может просматривать фото, открывать группы, видеть свои прошлые оценки и общие результаты (если включены).

## 2. Административные инструменты
- `admin.html`: Управление списком сессий (включая переключение статуса "Закрыто/Открыто").
- `prepare.html`: Быстрое создание сессии из списка URL.
- `editor.html`: Полноценный редактор.
- `recalc.html`: Инструмент восстановления целостности данных.
