
# Shutter Rank (Firebase Edition)

*Find what's cool -- cull the rest.*

Это веб-приложение для проведения фотоконкурсов со "слепым" голосованием. Эта версия интегрирована с Firebase для хранения данных в реальном времени и поддержки **нескольких независимых сессий** голосования.

## Ключевые возможности

- **Поддержка нескольких сессий**: Управляйте несколькими конкурсами в одной базе данных.
- **Доступ по URL**: Каждая сессия доступна по уникальному URL (например, `.../#session-id`).
- **5-звёздочная система рейтинга**: Участники оценивают фотографии по шкале от 1 до 5 звёзд.
- **Двойные лимиты**: Голосование ограничено как по количеству оценённых фотографий, так и по общей сумме звёзд.
- **Данные в реальном времени**: Конфигурация, список фотографий и результаты голосования хранятся в Firebase Realtime Database.
- **Сохранение голосов пользователей**: Голоса каждого пользователя сохраняются в базе данных под анонимным уникальным ID.

## Администрирование сессий

Для управления сессиями предусмотрены встроенные инструменты:

-   **`admin.html`**: Панель администратора. Отображает список всех сессий, позволяет создавать новые, удалять существующие и переходить к их редактированию или просмотру.
-   **`prepare.html`**: Инструмент для подготовки новой сессии. Позволяет создать сессию из списка URL фотографий, добавить описания и сохранить всё напрямую в Firebase.
-   **`editor.html`**: Редактор сессий. Позволяет загрузить существующую сессию, изменить её настройки (`config`), а также управлять списком фотографий (добавлять, удалять, редактировать описания).

## Развертывание (Deployment)

Развертывание проекта полностью автоматизировано с помощью **GitHub Actions**.

1.  **Настройте секрет в GitHub**:
    *   Перейдите в настройки вашего репозитория: `Settings` > `Secrets and variables` > `Actions`.
    *   Создайте новый секрет (`New repository secret`) с именем `FIREBASE_SERVICE_ACCOUNT_PHOTO_VOTING_930F3`.
    *   Вставьте в него содержимое JSON-ключа вашего сервисного аккаунта Firebase.

2.  **Процесс развертывания**:
    *   **Тестовая среда**: Каждый `push` в ветку `firebase-integration` автоматически развернет приложение на тестовый канал `dev`.
    *   **Продакшн**: Каждый `push` в ветку `main` развернет приложение на `live` канал.

Этот метод обеспечивает надежное и предсказуемое развертывание в чистой, изолированной среде.

## Интеграция с Firebase

### Структура данных

Все данные хранятся в корневом узле `sessions`. Каждый дочерний узел представляет собой отдельную сессию голосования с уникальным ID.

```json
{
  "sessions": {
    "fontainebleau": {
      "config": { "..."},
      "photos": { "..."},
      "votes":  { "..."},
      "userVotes": {
        "уникальный-id-пользователя-1": {
          "photo_id_1": 5,
          "photo_id_27": 3
        },
        "уникальный-id-пользователя-2": {
          "photo_id_1": 4
        }
      }
    }
  }
}
```

### Настройка и миграция данных

Для создания сессии рекомендуется использовать инструмент `prepare.html`. Для миграции старых данных можно воспользоваться `migration-tool.html`.

### Настройте правила безопасности (Ключ к решению `PERMISSION_DENIED`)

Ошибка `PERMISSION_DENIED` при сохранении данных в `editor.html` возникает, когда правила безопасности в вашей консоли Firebase не соответствуют тем, которые требуются для работы анонимных админ-инструментов.

**Чтобы исправить это, скопируйте и вставьте следующие правила в редактор правил вашей Realtime Database:**

```json
{
  "rules": {
    "sessions": {
      ".read": true,
      "$sessionId": {
        // РАЗРЕШИТЬ ЗАПИСЬ ДЛЯ АДМИН-ИНСТРУМЕНТОВ
        // Эти правила необходимы для работы admin.html, editor.html и prepare.html
        "config": { ".write": true },
        "photos": { ".write": true },
        
        // ПРАВИЛА ДЛЯ ГОЛОСОВАНИЯ
        // Эти правила разрешают пользователям записывать свои голоса
        "votes": {
          ".write": true
        },
        "userVotes": {
          "$userId": {
            ".write": "true",
            "$photoId": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 5"
            }
          }
        }
      }
    }
  }
}
```

**ВНИМАНИЕ:** Эти правила разрешают **любому** пользователю изменять `config` и `photos`. Для реального публичного приложения следует внедрить Firebase Authentication и ограничить доступ только для администраторов (например, `".write": "auth != null && auth.uid === 'YOUR_ADMIN_UID'"`).

### Сконфигурируйте приложение
Откройте файл `src/firebase.ts` и вставьте конфигурацию вашего веб-приложения Firebase.

### Управление данными
Управление конфигурацией и списком фотографий теперь осуществляется через **консоль Firebase** или с помощью встроенных инструментов **`admin.html`** и **`editor.html`**.
